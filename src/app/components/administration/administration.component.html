<div class="page-layout" dir="rtl">
  <app-sidebar></app-sidebar>

  <div class="page-content container my-4">
    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4">
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'users'" (click)="activeTab = 'users'" title="عرض الأقسام">
          الأقسام
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'sectors'" (click)="activeTab = 'sectors'"
          title="عرض القطاعات">
          القطاعات
        </a>
      </li>
    </ul>

    <!-- Users Tab -->
    <div *ngIf="activeTab === 'users'">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <div class="mb-2 mb-md-0">
          <h2 class="mb-1">إدارة الأقسام (إجمالي: {{ filteredList.length }})</h2>
          <p class="text-muted">إضافة وتعديل الأقسام المرتبطة بالمستخدمين</p>
        </div>
        <button class="btn btn-secondary" (click)="openAddDepartment()" title="إضافة قسم جديد">
          <i class="bi bi-plus-lg ms-1"></i> إضافة قسم
        </button>
      </div>

      <!-- Filters -->
      <div class="row mb-4 g-2">
        <div class="col-md-4">
          <label for="filterSector" class="visually-hidden">اختر القطاع</label>
          <select id="filterSector" class="form-select" [(ngModel)]="selectedSector" (change)="applyFilters()"
            title="اختر القطاع">
            <option value="">كل القطاعات</option>
            <option *ngFor="let s of sectors" [value]="s._id">{{ s.sector }}</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="searchDept" class="visually-hidden">بحث باسم القسم</label>
          <input id="searchDept" type="text" class="form-control" [(ngModel)]="searchTerm" (input)="applyFilters()"
            placeholder="ابحث باسم القسم ..." title="بحث باسم القسم" />
        </div>
        <div class="col-md-4 d-grid">
          <button class="btn btn-outline-secondary" (click)="resetFilters()" title="إعادة تعيين الفلاتر">
            <i class="bi bi-arrow-counterclockwise"></i> إعادة تعيين
          </button>
        </div>
      </div>

      <!-- Users Table -->
      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle text-center mb-0">
          <thead class="table-light">
            <tr>
              <th class="text-end">القطاع</th>
              <th class="text-end">اسم المستخدم</th>
              <th class="text-end">القسم</th>
              <th>الحالة</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredList">
              <td class="text-end">{{ user.sectorName || '---' }}</td>
              <td class="text-end">{{ user.username || '---' }}</td>
              <td class="text-end">{{ user.fullname || '---' }}</td>
              <td>
                <span class="badge px-3 py-2" [ngClass]="user.status === 'active' ? 'bg-success' : 'bg-danger'">
                  {{ user.status === 'active' ? 'نشط' : 'معطل' }}
                </span>
              </td>
              <td class="d-flex justify-content-center gap-1">
                <button class="btn btn-sm btn-warning" (click)="openEditUser(user)" title="تعديل المستخدم">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-secondary" (click)="toggleStatus(user)" title="تغيير حالة المستخدم">
                  <i class="bi bi-toggle-on"></i>
                </button>
                <button class="btn btn-sm btn-danger" (click)="deleteUser(user)" title="حذف المستخدم">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="filteredList.length === 0" class="text-center py-3 text-muted">لا يوجد أقسام لعرضها</div>
      </div>
    </div>

    <!-- Sectors Tab -->
    <div *ngIf="activeTab === 'sectors'">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">إدارة القطاعات (إجمالي: {{ sectors.length }})</h2>
        <button class="btn btn-secondary" (click)="openSectorForm()" title="إضافة قطاع جديد">
          <i class="bi bi-diagram-3 ms-1"></i> إضافة قطاع
        </button>
      </div>

      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>اسم القطاع</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let s of sectors">
              <td>{{ s.sector }}</td>
              <td class="d-flex justify-content-center gap-2">
                <button class="btn btn-sm btn-warning" (click)="editSector(s)" title="تعديل القطاع">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" (click)="deleteSector(s._id)" title="حذف القطاع">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="sectors.length === 0" class="text-center py-3 text-muted">لا يوجد قطاعات لعرضها</div>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Department Modal -->
<div *ngIf="showAddDepartmentModal" class="modal fade show d-block modal-backdrop-custom">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ newDepartment._id ? 'تعديل القسم' : 'إضافة قسم جديد' }}</h5>
        <button type="button" class="btn-close" (click)="closeAddDepartment()" title="إغلاق"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="deptSector" class="form-label">القطاع:</label>
          <select id="deptSector" class="form-select" [(ngModel)]="newDepartment.sector" title="اختر القطاع">
            <option value="" disabled selected>اختر اسم القطاع</option>
            <option *ngFor="let s of sectors" [value]="s._id">{{ s.sector }}</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="deptUsername" class="form-label">اسم المستخدم:</label>
          <input id="deptUsername" type="text" class="form-control" [(ngModel)]="newDepartment.username"
            placeholder="اسم المستخدم" title="اسم المستخدم" />
        </div>
        <div class="mb-3">
          <label for="deptFullname" class="form-label">الاسم الكامل (القسم):</label>
          <input id="deptFullname" type="text" class="form-control" [(ngModel)]="newDepartment.fullname"
            placeholder="اسم القسم" title="الاسم الكامل" />
        </div>
        <div class="mb-3 position-relative">
          <label for="deptPassword" class="form-label">كلمة المرور:</label>
          <input id="deptPassword" [type]="showPassword ? 'text' : 'password'" class="form-control"
            [(ngModel)]="newDepartment.password" placeholder="كلمة المرور" title="كلمة المرور" />
          <i class="bi" [ngClass]="showPassword ? 'bi-eye-slash' : 'bi-eye'" (click)="togglePassword()"
            class="password-toggle" title="إظهار/إخفاء كلمة المرور"></i>
        </div>
        <div class="mb-3">
          <label for="deptRole" class="form-label">الدور:</label>
          <select id="deptRole" class="form-select" [(ngModel)]="newDepartment.role" title="اختر الدور">
            <option value="user">مستخدم</option>
            <option value="admin">مشرف</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAddDepartment()" title="إلغاء">إلغاء</button>
        <button class="btn btn-primary" (click)="saveDepartment()" title="حفظ">حفظ</button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Sector Modal -->
<div *ngIf="showSectorForm" class="modal fade show d-block modal-backdrop-custom">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ newSector._id ? 'تعديل القطاع' : 'إضافة قطاع جديد' }}</h5>
        <button type="button" class="btn-close" (click)="closeSectorForm()" title="إغلاق"></button>
      </div>
      <div class="modal-body">
        <label for="sectorName" class="visually-hidden">اسم القطاع</label>
        <input id="sectorName" type="text" class="form-control" [(ngModel)]="newSector.sector"
          placeholder="اضف اسم القطاع" title="اسم القطاع" />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeSectorForm()" title="إلغاء">إلغاء</button>
        <button class="btn btn-primary" (click)="saveSector()" title="حفظ">حفظ</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div *ngIf="showEditUserModal" class="modal fade show d-block modal-backdrop-custom">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">تعديل القسم/المستخدم</h5>
        <button type="button" class="btn-close" (click)="closeEditUser()" title="إغلاق"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="editUserSector" class="form-label">القطاع:</label>
          <select id="editUserSector" class="form-select" [(ngModel)]="selectedUser.sector" title="اختر القطاع">
            <option *ngFor="let s of sectors" [value]="s._id">{{ s.sector }}</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="editUsername" class="form-label">اسم المستخدم:</label>
          <input id="editUsername" type="text" class="form-control" [(ngModel)]="selectedUser.username"
            placeholder="اسم المستخدم" title="اسم المستخدم" />
        </div>
        <div class="mb-3">
          <label for="editFullname" class="form-label">الاسم الكامل (القسم):</label>
          <input id="editFullname" type="text" class="form-control" [(ngModel)]="selectedUser.fullname"
            placeholder="اسم القسم" title="الاسم الكامل" />
        </div>
        <div class="mb-3">
          <label for="editRole" class="form-label">الدور:</label>
          <select id="editRole" class="form-select" [(ngModel)]="selectedUser.role" title="اختر الدور">
            <option value="user">مستخدم</option>
            <option value="admin">مشرف</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="editStatus" class="form-label">الحالة:</label>
          <select id="editStatus" class="form-select" [(ngModel)]="selectedUser.status" title="اختر الحالة">
            <option value="active">نشط</option>
            <option value="inactive">معطل</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeEditUser()" title="إلغاء">إلغاء</button>
        <button class="btn btn-primary" (click)="confirmEditUser()" title="حفظ">حفظ</button>
      </div>
    </div>
  </div>
</div>